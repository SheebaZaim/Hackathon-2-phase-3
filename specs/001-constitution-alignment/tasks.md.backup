# Tasks: Phase III Constitution Alignment - AI Chat Todo Manager

**Input**: Design documents from `/specs/001-constitution-alignment/`
**Prerequisites**: plan.md (required), spec.md (required), research.md, data-model.md, contracts/

**Organization**: Tasks are grouped by user story to enable independent implementation and testing of each story.

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (e.g., US1, US2, US3)
- Include exact file paths in descriptions

## Path Conventions

- **Web app**: `backend/src/`, `frontend/src/`
- Paths shown below use web app structure per plan.md

---

## Phase 1: Setup (Shared Infrastructure)

**Purpose**: Project initialization and environment setup

- [ ] T001 Install OpenAI Python SDK in backend/requirements.txt (add openai==1.10.0)
- [ ] T002 Install MCP SDK in backend/requirements.txt (add mcp==0.1.0)
- [ ] T003 [P] Create .env.example files documenting required environment variables (OPENAI_API_KEY, MCP_SERVER_PORT)
- [ ] T004 [P] Create backend/src/agent/__init__.py directory structure
- [ ] T005 [P] Create backend/src/mcp/__init__.py directory structure
- [ ] T006 [P] Create backend/src/mcp/tools/__init__.py directory structure

---

## Phase 2: Foundational (Blocking Prerequisites)

**Purpose**: Core infrastructure that MUST be complete before ANY user story can be implemented

**‚ö†Ô∏è CRITICAL**: No user story work can begin until this phase is complete

### Database Models

- [ ] T007 [P] Create Conversation model in backend/src/models/conversation.py per data-model.md constitution schema
- [ ] T008 [P] Create Message model in backend/src/models/message.py per data-model.md constitution schema
- [ ] T009 Update Task model in backend/src/models/task.py to match constitution schema (change id to int, user_id to string, remove priority/due_date/category fields)
- [ ] T010 Update User model in backend/src/models/user.py to use string id type instead of UUID

### Database Migrations

- [ ] T011 Create migration script migrations/003_add_conversation_model.sql
- [ ] T012 Create migration script migrations/004_add_message_model.sql
- [ ] T013 Create migration script migrations/005_migrate_task_to_constitution_schema.sql
- [ ] T014 [P] Create database indexes per data-model.md (conversations.user_id, messages.conversation_id, tasks.user_id)
- [ ] T015 Run and verify all database migrations complete successfully

### Authentication Updates

- [ ] T016 Update auth service in backend/src/services/auth.py to support string user_id in JWT tokens
- [ ] T017 Update auth middleware in backend/src/middleware/auth.py to extract string user_id from tokens

**Checkpoint**: Foundation ready - user story implementation can now begin in parallel

---

## Phase 3: User Story 1 - Chat with AI to Manage Tasks (Priority: P1) üéØ MVP

**Goal**: Users can manage tasks through natural language AI chat

**Independent Test**: Send chat message "remind me to buy groceries", verify task created and AI confirms. Send "show my tasks", verify task appears in list.

### MCP Tools Implementation

- [ ] T018 [P] [US1] Implement add_task MCP tool in backend/src/mcp/tools/add_task.py per contracts/add-task-tool.yaml
- [ ] T019 [P] [US1] Implement list_tasks MCP tool in backend/src/mcp/tools/list_tasks.py per contracts/list-tasks-tool.yaml
- [ ] T020 [P] [US1] Implement complete_task MCP tool in backend/src/mcp/tools/complete_task.py per contracts/complete-task-tool.yaml
- [ ] T021 [P] [US1] Implement delete_task MCP tool in backend/src/mcp/tools/delete_task.py per contracts/delete-task-tool.yaml
- [ ] T022 [P] [US1] Implement update_task MCP tool in backend/src/mcp/tools/update_task.py per contracts/update-task-tool.yaml
- [ ] T023 [US1] Create MCP server setup in backend/src/mcp/server.py registering all 5 tools

### AI Agent Integration

- [ ] T024 [US1] Implement OpenAI agent wrapper in backend/src/agent/openai_agent.py using Assistants API per research.md
- [ ] T025 [US1] Implement stateless chat handler in backend/src/agent/chat_handler.py following 8-step execution cycle per constitution
- [ ] T026 [US1] Configure OpenAI agent with MCP tools as function schemas

### Chat API Endpoint

- [ ] T027 [US1] Implement chat endpoint POST /api/{user_id}/chat in backend/src/api/chat.py per contracts/chat-api.yaml
- [ ] T028 [US1] Add chat endpoint to FastAPI router in backend/src/main.py
- [ ] T029 [US1] Implement request validation (user_id matches auth, message validation)
- [ ] T030 [US1] Implement error handling for AI service failures and database errors

### Basic Frontend Chat UI

- [ ] T031 [P] [US1] Create ChatInterface component in frontend/src/components/chat/ChatInterface.tsx (basic structure, no Figma design yet)
- [ ] T032 [P] [US1] Create MessageList component in frontend/src/components/chat/MessageList.tsx
- [ ] T033 [P] [US1] Create MessageInput component in frontend/src/components/chat/MessageInput.tsx
- [ ] T034 [US1] Create chat page in frontend/src/app/chat/page.tsx
- [ ] T035 [US1] Implement chat API client in frontend/src/lib/chat-api.ts calling POST /api/{user_id}/chat
- [ ] T036 [US1] Connect chat components to API client with message send/receive

**Checkpoint**: At this point, User Story 1 should be fully functional and testable independently. Users can chat with AI to manage tasks.

---

## Phase 4: User Story 2 - Persistent Conversation History (Priority: P2)

**Goal**: Users can continue previous conversations with full history preserved

**Independent Test**: Start conversation, create task via chat, close/reopen app, verify conversation history loads and user can continue chatting

### Conversation Management Backend

- [ ] T037 [US2] Implement conversation service in backend/src/services/conversation_service.py (create, retrieve, update conversation)
- [ ] T038 [US2] Implement message service in backend/src/services/message_service.py (store user/assistant messages)
- [ ] T039 [US2] Update chat_handler.py to use conversation/message services for persistence
- [ ] T040 [US2] Implement conversation retrieval endpoint GET /api/{user_id}/conversations in backend/src/api/chat.py
- [ ] T041 [US2] Implement conversation messages endpoint GET /api/{user_id}/conversations/{conversation_id}/messages

### Frontend Conversation Persistence

- [ ] T042 [US2] Add conversation history display to ChatInterface component
- [ ] T043 [US2] Implement conversation list sidebar in frontend/src/components/chat/ConversationList.tsx
- [ ] T044 [US2] Add conversation switching functionality (load different conversations)
- [ ] T045 [US2] Implement "New conversation" button functionality
- [ ] T046 [US2] Add conversation state management (store active conversation_id)

**Checkpoint**: User Stories 1 AND 2 should both work independently. Users can manage tasks via chat AND return to previous conversations.

---

## Phase 5: User Story 3 - Modern Chat Interface with Figma Design (Priority: P3)

**Goal**: Professional chat UI following Figma design specifications

**Independent Test**: Compare implemented UI against Figma design (https://www.figma.com/community/file/1243994932810853146), verify colors, typography, spacing, responsive behavior

### Figma Design Extraction

- [ ] T047 [P] [US3] Extract design tokens from Figma (colors, typography, spacing) and document in frontend/src/styles/design-tokens.ts
- [ ] T048 [US3] Update tailwind.config.ts with Figma design tokens (colors, fonts, spacing scale)

### UI Component Styling

- [ ] T049 [P] [US3] Apply Figma design to ChatInterface.tsx (layout, spacing, container styling)
- [ ] T050 [P] [US3] Apply Figma design to MessageList.tsx (message bubbles, alignment, colors)
- [ ] T051 [P] [US3] Apply Figma design to MessageInput.tsx (input field, send button styling)
- [ ] T052 [P] [US3] Create TypingIndicator component in frontend/src/components/chat/TypingIndicator.tsx per Figma design
- [ ] T053 [US3] Add TypingIndicator to ChatInterface showing during AI processing

### Responsive Design

- [ ] T054 [US3] Implement responsive breakpoints per Figma specifications (mobile, tablet, desktop)
- [ ] T055 [US3] Test and fix mobile layout (320px width minimum per spec)
- [ ] T056 [US3] Add smooth message animations per Figma design system
- [ ] T057 [US3] Implement auto-scroll to latest message with smooth transition

**Checkpoint**: All user stories complete. Full AI chat todo manager with persistent conversations and professional UI.

---

## Phase 6: Polish & Cross-Cutting Concerns

**Purpose**: Improvements that affect multiple user stories

- [ ] T058 [P] Add logging for all MCP tool executions per constitution requirement (backend/src/mcp/tools/)
- [ ] T059 [P] Implement rate limiting on chat endpoint to prevent abuse (backend/src/middleware/rate_limit.py)
- [ ] T060 [P] Add input sanitization for user messages to prevent injection attacks (backend/src/services/validation.py)
- [ ] T061 [P] Implement conversation archival for 90+ day old conversations (backend/src/services/conversation_service.py)
- [ ] T062 [P] Add OpenAI API error handling with retry logic (backend/src/agent/openai_agent.py)
- [ ] T063 [P] Optimize database queries with connection pooling validation (backend/src/database/)
- [ ] T064 Update README.md with Phase III setup instructions per quickstart.md
- [ ] T065 [P] Add error boundaries to frontend chat components (frontend/src/components/chat/ErrorBoundary.tsx)
- [ ] T066 [P] Implement loading states for all async operations (frontend components)
- [ ] T067 Verify quickstart.md instructions work end-to-end

---

## Dependencies & Execution Order

### Phase Dependencies

- **Setup (Phase 1)**: No dependencies - can start immediately
- **Foundational (Phase 2)**: Depends on Setup completion - BLOCKS all user stories
- **User Stories (Phase 3-5)**: All depend on Foundational phase completion
  - User stories can then proceed in parallel (if staffed)
  - Or sequentially in priority order (P1 ‚Üí P2 ‚Üí P3)
- **Polish (Phase 6)**: Depends on all desired user stories being complete

### User Story Dependencies

- **User Story 1 (P1)**: Can start after Foundational (Phase 2) - No dependencies on other stories
- **User Story 2 (P2)**: Can start after Foundational (Phase 2) - Integrates with US1 but independently testable
- **User Story 3 (P3)**: Can start after Foundational (Phase 2) - Enhances US1/US2 UI but independently testable

### Within Each User Story

- MCP tools can be implemented in parallel (T018-T022 all [P])
- Frontend chat components can be built in parallel (T031-T033 all [P])
- Figma design components can be styled in parallel (T049-T051 all [P])
- Each story completes with integration tasks (non-parallel)

### Parallel Opportunities

- **Setup Phase**: T003-T006 can run in parallel
- **Foundational Phase**: T007-T008 (models), T011-T012 (migrations), T014 (indexes) can run in parallel
- **US1 MCP Tools**: T018-T022 can run in parallel (5 tools)
- **US1 Frontend**: T031-T033 can run in parallel (3 components)
- **US3 Styling**: T047-T048, T049-T051 can run in parallel
- **Polish Phase**: T058-T063, T065-T066 can run in parallel

---

## Parallel Example: User Story 1

```bash
# Launch all MCP tools together (parallel):
Task T018: "Implement add_task MCP tool in backend/src/mcp/tools/add_task.py"
Task T019: "Implement list_tasks MCP tool in backend/src/mcp/tools/list_tasks.py"
Task T020: "Implement complete_task MCP tool in backend/src/mcp/tools/complete_task.py"
Task T021: "Implement delete_task MCP tool in backend/src/mcp/tools/delete_task.py"
Task T022: "Implement update_task MCP tool in backend/src/mcp/tools/update_task.py"

# Launch all frontend components together (parallel):
Task T031: "Create ChatInterface component in frontend/src/components/chat/ChatInterface.tsx"
Task T032: "Create MessageList component in frontend/src/components/chat/MessageList.tsx"
Task T033: "Create MessageInput component in frontend/src/components/chat/MessageInput.tsx"
```

---

## Implementation Strategy

### MVP First (User Story 1 Only)

1. Complete Phase 1: Setup
2. Complete Phase 2: Foundational (CRITICAL - blocks all stories)
3. Complete Phase 3: User Story 1 (MVP)
4. **STOP and VALIDATE**: Test User Story 1 independently
   - Send chat message to create task
   - Verify AI creates task via add_task tool
   - Send message to list tasks
   - Send message to complete task
   - Send message to delete task
5. Demo MVP: Working AI chat todo manager

### Incremental Delivery

1. Complete Setup + Foundational ‚Üí Foundation ready
2. Add User Story 1 ‚Üí Test independently ‚Üí Deploy/Demo (MVP!)
3. Add User Story 2 ‚Üí Test independently ‚Üí Deploy/Demo (Persistent conversations!)
4. Add User Story 3 ‚Üí Test independently ‚Üí Deploy/Demo (Professional UI!)
5. Each story adds value without breaking previous stories

### Parallel Team Strategy

With multiple developers:

1. Team completes Setup + Foundational together
2. Once Foundational is done:
   - Developer A: User Story 1 (backend MCP tools + AI agent)
   - Developer B: User Story 1 (frontend chat UI)
   - Developer C: User Story 2 (conversation persistence)
3. Stories complete and integrate independently

---

## Notes

- [P] tasks = different files, no dependencies
- [Story] label maps task to specific user story for traceability
- Each user story should be independently completable and testable
- Stop at any checkpoint to validate story independently
- Commit after each task or logical group
- **No tests included** - tests not requested in specification
- Avoid: vague tasks, same file conflicts, cross-story dependencies that break independence

---

## Task Summary

**Total Tasks**: 67

**By Phase**:
- Phase 1 (Setup): 6 tasks
- Phase 2 (Foundational): 11 tasks (BLOCKS all stories)
- Phase 3 (US1 - MVP): 19 tasks
- Phase 4 (US2): 10 tasks
- Phase 5 (US3): 11 tasks
- Phase 6 (Polish): 10 tasks

**By User Story**:
- US1 (Chat with AI to Manage Tasks): 19 tasks
- US2 (Persistent Conversation History): 10 tasks
- US3 (Modern Chat Interface with Figma): 11 tasks
- Shared/Infrastructure: 27 tasks

**Parallel Opportunities**: 28 tasks marked [P] (42% of total)

**MVP Scope**: Phase 1 + Phase 2 + Phase 3 (US1) = 36 tasks
